# Media Server (Homelab)

A lightweight FastAPI image hosting service. Frontends upload images here and receive a URL to store in your Django backend.

## Setup

```bash
pip install fastapi uvicorn python-dotenv python-multipart
cp .env.example .env
# Edit .env and set a strong MEDIA_SERVER_SECRET
uvicorn main:app --host 0.0.0.0 --port 8000
```

## Environment Variables

| Variable | Required | Default | Description |
|---|---|---|---|
| `MEDIA_SERVER_SECRET` | ✅ | — | Shared HMAC secret. Must match your Django backend. |
| `TOKEN_EXPIRY_SECONDS` | ❌ | `900` | How long an upload token is valid (seconds). |

## Authentication Flow

This server uses **HMAC-signed tokens** instead of API keys. The token is generated by your Django backend (which has already authenticated the user) and passed to the frontend for uploading.

```
1. User logs in → Frontend authenticates with Django backend
2. Frontend requests an upload token → GET /api/upload-token/  (Django)
3. Django generates a signed token and returns it
4. Frontend uploads image → POST /upload?token=<token>  (Media Server)
5. Media Server verifies token signature + expiry, stores the image
6. Media Server returns the image URL
7. Frontend sends the URL to Django to store in the database
```

### Generating tokens in Django

Use the **same `MEDIA_SERVER_SECRET`** in your Django settings and generate tokens like this:

```python
import hmac
import hashlib
import time
from django.conf import settings

def generate_upload_token():
    ts = str(int(time.time()))
    sig = hmac.new(
        settings.MEDIA_SERVER_SECRET.encode(),
        ts.encode(),
        hashlib.sha256,
    ).hexdigest()
    return f"{ts}.{sig}"
```

Then expose it via a view (only for authenticated users):

```python
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response

@api_view(["GET"])
@permission_classes([IsAuthenticated])
def upload_token_view(request):
    return Response({"token": generate_upload_token()})
```

## API Endpoints

| Method | Path | Auth | Description |
|---|---|---|---|
| `GET` | `/` | Public | Health check |
| `POST` | `/upload?token=<token>` | Token | Upload an image (multipart `file` field) |
| `GET` | `/media/{filename}` | Public | Serve a stored image |
| `DELETE` | `/media/{filename}?token=<token>` | Token | Delete a stored image |
| `GET` | `/media` | Public | List all stored images |

## Allowed file types

`.jpg`, `.jpeg`, `.png`, `.gif`, `.webp`, `.svg`, `.bmp`

Max file size: **10 MB**